<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Payment Confirmed Â· amavia</title>
<style>
  :root{
    --bg:#0d2e22;
    --text:#e7efe9;
    --muted:#a7b7af;
    --gold:#eed558;
  }

  /* Page */
  html,body{height:100%}
  body{
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:24px;
    overflow-x:hidden;
  }

  /* Watermark */
  body::before{
    content:"ðŸŒ¿";
    position:fixed;
    inset:0;
    margin:auto;
    font-size:360px;
    color:rgba(154,208,181,0.06);
    filter:blur(1px);
    transform:rotate(-18deg);
    pointer-events:none;
    user-select:none;
  }

  /* Content wrapper */
  .wrap{
    position:relative;
    z-index:1;
    max-width:720px;
    width:100%;
  }

  /* Centered animated checkmark */
  .checkmark{
    width:90px;height:90px;border-radius:50%;
    border:4px solid var(--gold);
    display:flex;align-items:center;justify-content:center;
    margin:0 auto 24px auto;
    box-shadow:0 0 25px rgba(238,213,88,0.30);
    animation:pop .4s ease-out;
  }
  .checkmark::after{
    content:"";
    width:26px;height:46px;
    border-right:4px solid var(--gold);
    border-bottom:4px solid var(--gold);
    transform:rotate(45deg) scale(0);
    animation:draw .5s .3s ease-out forwards;
  }
  @keyframes pop{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}
  @keyframes draw{to{transform:rotate(45deg) scale(1)}}

  h1{
    color:var(--gold);
    font-size:clamp(1.6rem,2.2vw,2.1rem);
    letter-spacing:.4px;
    margin:0 0 .5rem 0;
  }
  p{line-height:1.6;max-width:52ch;margin:0 auto 10px auto}
  .muted{color:var(--muted)}
  .tm{font-size:.7em;vertical-align:super}

  /* Button */
  .btn{
    display:inline-block;
    background:var(--gold);
    color:var(--bg);
    text-decoration:none;
    font-weight:700;
    padding:14px 34px;
    border-radius:10px;
    margin:22px 0 10px 0;
    transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
    box-shadow:0 8px 24px rgba(238,213,88,.18);
  }
  .btn:hover{transform:translateY(-2px);background:#f1e47a}

  /* Detected purchase */
  .detected{margin-top:8px;font-size:.95rem;color:var(--muted)}

  /* Footer (single â„¢ only) */
  footer{
    margin-top:18px;
    font-size:.85rem;
    color:var(--muted);
    letter-spacing:.04em;
  }
</style>
</head>
<body>
  <main class="wrap">
    <div class="checkmark"></div>
    <h1>Payment Confirmed</h1>
    <p>Thank you for your purchase. We are honored that you have chosen <strong>amavia<span class="tm">â„¢</span></strong> to help commemorate your loved one.</p>
    <p>Please take a moment to complete the family details form â€” this helps our team begin preparing your order with care and accuracy.</p>

    <!-- This buttonâ€™s link is updated by the script once we know the service(s) -->
    <a id="intakeBtn" class="btn" href="https://tally.so/r/OD17oK" target="_blank" rel="noopener noreferrer">
      Continue to Intake Form
    </a>

    <div id="detected" class="detected muted" aria-live="polite"></div>

    <footer>guided by love Â· amaviaâ„¢</footer>
  </main>

<script>
/* ------------ Configure your Tally form once here ------------ */
const TALLY_FORM_ID = 'OD17oK';
const BASE_TALLY = `https://tally.so/r/${TALLY_FORM_ID}`;

/* Helpers */
const params = new URLSearchParams(location.search);
const sessionId = params.get('session_id');

function normalizeName(n){
  if(!n) return '';

  const s = n.trim();

  // Collapse Thank You Cards sizes into one label
  if (/^thank you cards/i.test(s)) return 'Thank You Cards';

  // Strip â€œ(Save $xxx)â€ from packages
  if (/legacy package/i.test(s))   return 'Legacy Package';
  if (/complete.*package/i.test(s))return 'Complete Memorial Package';
  if (/essential.*package/i.test(s))return 'Essential Package';

  // Remove any trailing size/notes in parentheses if you ever add them
  return s.replace(/\s*\([^)]*\)\s*$/,'').trim();
}

async function init(){
  const btn = document.getElementById('intakeBtn');
  const detected = document.getElementById('detected');

  try{
    if(!sessionId) throw new Error('Missing session_id');

    // Ask our API what was purchased (make sure your API expects `session_id`)
    const res = await fetch(`/api/verify-session?session_id=${encodeURIComponent(sessionId)}`);
    const data = await res.json();
    if(!data || !Array.isArray(data.items)) throw new Error('Could not read purchased items');

    // Clean, dedupe names
    const names = [];
    for(const it of data.items){
      const cleaned = normalizeName(it.name);
      if(cleaned && !names.includes(cleaned)) names.push(cleaned);
    }

    // Build the Tally link with hidden field(s)
    let target = BASE_TALLY;
    if(names.length === 1){
      target = `${BASE_TALLY}?service=${encodeURIComponent(names[0])}`;
    }else if(names.length > 1){
      target = `${BASE_TALLY}?services=${encodeURIComponent(names.join(','))}`;
    }

    // Update button & detected text (no auto-redirect)
    btn.href = target;
    if(names.length){
      detected.textContent = `Detected purchase: ${names.join(', ')}.`;
    }else{
      detected.textContent = '';
    }
  }catch(e){
    console.error(e);
    // Fall back: plain Tally link stays
    detected.textContent = '';
  }
}

init();
</script>
</body>
</html>
