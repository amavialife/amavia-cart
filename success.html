<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Payment Confirmed Â· amavia</title>
<style>
  body {
    background-color: #0d2e22;
    color: #e7efe9;
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
    padding: 20px;
    overflow: hidden;
  }

  /* ðŸŒ¿ Leaf watermark */
  body::before {
    content: "ðŸŒ¿";
    position: absolute;
    font-size: 320px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-20deg);
    color: rgba(154, 208, 181, 0.05);
    filter: blur(1px);
    user-select: none;
    pointer-events: none;
  }

  /* âœ… Animated checkmark circle */
  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: inline-block;
    border: 4px solid #eed558;
    position: relative;
    box-shadow: 0 0 20px rgba(238,213,88,0.25);
    margin-bottom: 24px;
    animation: pop 0.4s ease-out;
  }

  .checkmark::after {
    content: '';
    position: absolute;
    left: 22px;
    top: 38px;
    width: 20px;
    height: 40px;
    border-right: 4px solid #eed558;
    border-bottom: 4px solid #eed558;
    transform: rotate(45deg) scale(0);
    transform-origin: center;
    animation: draw 0.5s 0.3s ease-out forwards;
  }

  @keyframes pop {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes draw {
    to { transform: rotate(45deg) scale(1); }
  }

  h1 {
    color: #eed558;
    font-size: 1.9em;
    margin-bottom: 0.4em;
    letter-spacing: 0.5px;
  }

  p {
    max-width: 420px;
    line-height: 1.6;
    color: #e7efe9;
  }

  a.btn {
    display: inline-block;
    background: #eed558;
    color: #0d2e22;
    text-decoration: none;
    font-weight: 600;
    padding: 14px 34px;
    border-radius: 8px;
    margin-top: 28px;
    transition: all 0.25s ease;
  }

  a.btn:hover {
    background: #f1e47a;
    transform: translateY(-2px);
  }

  footer {
    position: absolute;
    bottom: 20px;
    font-size: 13px;
    color: #a7b7af;
    letter-spacing: 0.04em;
  }
</style>
</head>
<body>
    <div class="checkmark"></div>
    <h1>Payment Confirmed</h1>
    <p>Thank you for your purchase. We are honored that you have chosen <strong>amavia<span class="tm">â„¢</span></strong> to help commemorate your loved one.</p>  
    </p>Please take a moment to complete the family details form below â€” this helps our team begin preparing your order with care and accuracy.</p>
    <a href="https://amavia.life/#writtenservicespaymentthankyou" class="btn" target="_blank" rel="noopener noreferrer">
    Continue to Intake Form
    </a>
    <footer>guided by love Â· amaviaâ„¢<span class="tm">â„¢</span></footer>
  </div>
  <script>
 // ========= CONFIG =========
  const TALLY_FORM_ID = 'OD17oK'; // your Tally form id
  const BASE_TALLY = `https://tally.so/r/${TALLY_FORM_ID}`;

  // Map your Stripe product names -> the labels your Tally logic expects
  // (Left side must match EXACT names in Stripe Products)
  const NAME_MAP = {
    // Obituaries
    'Basic Obituary': 'Basic Obituary',
    'Premium Obituary': 'Premium Obituary',
    'Legacy Obituary': 'Legacy Obituary',

    // Eulogies
    'Basic Eulogy': 'Basic Eulogy',
    'Premium Eulogy': 'Premium Eulogy',

    // Program / Announcement / Letter
    'Service Program': 'Service Program',
    'Death Announcement': 'Death Announcement',
    'Legacy Letter': 'Legacy Letter',

    // Thank You Cards â€” normalize all variants to one label
    'Thank You Cards (10)': 'Thank You Cards',
    'Thank You Cards (25)': 'Thank You Cards',
    'Thank You Cards (50)': 'Thank You Cards',

    // Packages (keep as package names or expand via PACKAGE_EXPANSIONS below)
    'Essential Package': 'Essential Package',
    'Complete Memorial Package': 'Complete Memorial Package',
    'Legacy Package': 'Legacy Package',
  };

  // If you want packages to EXPAND to components for Tally conditions,
  // list them here; otherwise leave empty and handle packages in Tally logic.
  const PACKAGE_EXPANSIONS = {
    // Example (adjust to your real package contents if desired):
    // 'Complete Memorial Package': ['Premium Obituary', 'Basic Eulogy', 'Service Program', 'Thank You Cards', 'Death Announcement'],
    // 'Legacy Package': ['Legacy Obituary', 'Premium Eulogy', 'Service Program', 'Thank You Cards'],
    // 'Essential Package': ['Basic Obituary', 'Service Program']
  };

  // ========= HELPERS =========
  const uniq = (arr) => Array.from(new Set(arr));
  function normalizeName(raw) {
    if (!raw) return '';
    const t = raw.trim();
    if (NAME_MAP[t]) return NAME_MAP[t];                         // exact map first
    if (/^thank you cards/i.test(t)) return 'Thank You Cards';   // loose helper
    return t;
  }

  // ========= MAIN =========
  (async function () {
    const params = new URLSearchParams(location.search);
    const sid = params.get('session_id'); // Stripe sends ?session_id=...
    const btn = document.querySelector('a.btn');

    // Start with button disabled until we know the target
    if (btn) {
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '0.5';
    }

    if (!sid) {
      // Fallback: allow the user to open the base form
      if (btn) {
        btn.href = BASE_TALLY;
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
      }
      return;
    }

    try {
      // Ask our API what was purchased
      const res = await fetch(`/api/verify-session?id=${encodeURIComponent(sid)}`);
      const data = await res.json();
      if (!data.items || !Array.isArray(data.items)) throw new Error('No items found');

      // Normalize names & optionally expand packages
      let names = [];
      for (const it of data.items) {
        let n = normalizeName(it.name);
        if (!n) continue;

        if (PACKAGE_EXPANSIONS[n]) {
          names.push(...PACKAGE_EXPANSIONS[n]);
        } else {
          names.push(n);
        }
      }
      names = uniq(names);

      // Build Tally URL (single vs multiple)
      let toUrl;
      if (names.length <= 1) {
        const single = names[0] || '';
        toUrl = single ? `${BASE_TALLY}?service=${encodeURIComponent(single)}`
                       : BASE_TALLY;
      } else {
        toUrl = `${BASE_TALLY}?services=${encodeURIComponent(names.join(','))}`;
      }

      // Enable the existing button and point it to the correct Tally link
      if (btn) {
        btn.href = toUrl;
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
      }

      // No auto-redirect â€” user will click when ready
      console.log('Stripe items:', data.items);
      console.log('Normalized names:', names, 'â†’ Tally URL:', toUrl);

    } catch (e) {
      console.error(e);
      // Graceful fallback: base form still works
      if (btn) {
        btn.href = BASE_TALLY;
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
      }
    }
  })();
</script>
</body>
</html>

