<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amavia · Cart</title>

  <style>
  /* ===== Amavia theme ===== */
  :root{
    --bg:#0d2e22;         /* page background (deep green) */
    --panel:#102f25;      /* panels */
    --line:#1d4a39;       /* borders */
    --text:#e7efe9;       /* primary text */
    --muted:#a7b7af;      /* secondary text */
    --accent:#eed558;     /* button yellow */
    --header-h:64px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* ===== Header with brand (left) + cart pill (right) ===== */
  header{
    position:sticky; top:0; z-index:60;
    height:var(--header-h);
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding:0 16px;
    background:var(--bg); border-bottom:1px solid var(--line);
  }
  .brand{ font-weight:700; letter-spacing:.4px; color:var(--text); }
  .tm{ font-size:10px; vertical-align:super; margin-left:2px; }
  .cart-pill{
    background:var(--panel);
    border:1px solid var(--line);
    color:var(--text);
    border-radius:999px;
    padding:8px 12px;
    font-weight:700;
    cursor:pointer;
    white-space:nowrap;
    transition:filter .15s ease;
  }
  .cart-pill:hover{ filter:brightness(1.08); }

  /* ===== Main becomes a single scrolling list ===== */
  main{ max-width:900px; margin:0 auto; padding:16px; padding-top:20px; }
  .layout{ display:block; }   /* no grid; just one column */
  .grid{ display:block; }     /* stack cards vertically */

  .category{
    margin:18px 0 10px;
    color:var(--muted);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.12em;
  }

  /* List-style cards: row with content left, price+button right */
  .card{
    display:flex; align-items:flex-start; gap:14px;
    background:var(--panel); border:1px solid var(--line); border-radius:14px;
    padding:14px; margin-bottom:12px;
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.25); border-color:var(--line); }
  .title{ margin:0 0 4px; font-size:16px; font-weight:700; }
  .desc{ margin:0; color:var(--muted); font-size:13px; }
  .price{ margin-left:auto; margin-right:12px; font-weight:700; }

  .btn{
    background:var(--accent); color:#000;       /* yellow button with black text */
    border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer;
    transition:transform .08s ease, filter .15s ease;
  }
  .btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  /* ===== Cart panel (toggles from the cart pill) ===== */
  .side{
    position:fixed; top:calc(var(--header-h) + 8px); right:16px; z-index:70;
    width:340px; max-height:70vh; overflow:auto;
    background:var(--panel); border:1px solid var(--line); border-radius:14px;
    padding:14px; box-shadow:0 12px 24px rgba(0,0,0,.35);
    display:none;   /* hidden by default */
  }
  .side.open{ display:block; }

  .row{ display:flex; justify-content:space-between; align-items:center; margin:8px 0; }
  .small{ font-size:13px; color:var(--muted); }
  .empty{ color:var(--muted); text-align:center; padding:20px; border:1px dashed var(--line); border-radius:12px; }
  .qty{ display:flex; align-items:center; gap:8px; }
  .qty button{
    width:28px; height:28px; border-radius:8px;
    border:1px solid var(--line); background:#0e1613; color:var(--text); cursor:pointer;
  }

  /* Mobile: cart becomes bottom sheet */
  @media (max-width: 900px){
    .side{
      width:auto; left:12px; right:12px; top:auto; bottom:12px; max-height:70vh;
    }
  }
  </style>
</head>

<body>
  <header>
    <div class="brand">amavia<span class="tm">™</span></div>
    <button id="cart-toggle" class="cart-pill">
      Cart · <span id="cart-count">0</span> · <span id="cart-total">$0.00</span>
    </button>
  </header>

  <main>
    <div class="layout">
      <section>
        <h2 style="margin:4px 0 12px 0">Templates & Services</h2>
        <div id="product-list" class="grid"></div>
      </section>

      <!-- Cart panel (toggles) -->
      <aside class="side" id="cart-panel">
        <h3 style="margin:0 0 8px 0">Your Cart</h3>
        <div id="cart-items" class="empty">Your cart is empty.</div>
        <div class="row"><span class="small">Subtotal</span><strong id="subtotal">$0.00</strong></div>
        <p class="small">Taxes are calculated at checkout. All prices in CAD.</p>
        <button id="checkout" class="btn" disabled>Proceed to Checkout</button>
        <button id="cancel" class="btn" style="background:#eed558; color:#000;">Cancel Order</button>
      </aside>
    </div>
  </main>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
  // 1) Your publishable test key
  const stripe = Stripe('pk_test_51SJEXtCeZgmr4yWZU6yP7VQ9bmKnZitQxo42by2n0kx428MTLxi3KjJighpbKnl7G3zUnMOwUJS7JGz0aQ2tfegs00x04Cx129');

  // 2) Your products (16)
  const PRODUCTS = [
    // PACKAGES
    {cat:'Packages', name:'Essential Package',             price:19900,  priceId:'price_1SQqGsCeZgmr4yWZTYdTWkyH', desc:'Core set of memorial assets - Obituary (Basic), Death Announcement, Service Program Outline.'},
    {cat:'Packages', name:'Complete Memorial Package',     price:49900,  priceId:'price_1SPvAeCipX1klfWPE2yO6sy5', desc:'Obituary (Premium) Death Announcement, Service Program, Eulogy (Basic).'},
    {cat:'Packages', name:'Legacy Package',                price:129900, priceId:'price_1SPvD1CipX1klfWPgsL6wunX', desc:'Obituary (Legacy - extended), Eulogy (Premium - full), Complete Service Program, Legacy Letter (one recipient), 25 Thank You Cards, 1-year memorial page hosting on amavia™.'},

    // OBITUARIES
    {cat:'Obituaries', name:'Basic Obituary',              price:14900,  priceId:'price_1SPupSCipX1klfWPOuzr6NOg', desc:'Thoughtful, polished obituary.200-300 words, 48-hour delivery.'},
    {cat:'Obituaries', name:'Premium Obituary',            price:29900,  priceId:'price_1SPuqTCipX1klfWPCK0R9qXL', desc:'Long-form tribute with edits. 400-600 words, richer life story, 24-hour delivery.'},
    {cat:'Obituaries', name:'Legacy Obituary',             price:49900,  priceId:'price_1SPuvCCipX1klfWPddKUIzrl', desc:'Executive-level storytelling. 800-1000 words, full narrative, same-day rush available.'},

    // ANNOUNCEMENTS
    {cat:'Announcements', name:'Death Announcement',       price:6900,   priceId:'price_1SPuxHCipX1klfWPgAPF5OCO', desc:'Compassionate notifications for family, friends, workplace, or social media. Delivered in 24 hours.'},

    // EULOGIES
    {cat:'Eulogies', name:'Basic Eulogy',                  price:14900,  priceId:'price_1SPuzJCipX1klfWPNp6aBnyp', desc:'Sincere words for the service. 5-7 minutes, key stories, standard delivery.'},
    {cat:'Eulogies', name:'Premium Eulogy',                price:29900,  priceId:'price_1SPv06CipX1klfWPzziESfSy', desc:'Deeper narrative & revisions. 10-15 minutes, deeply personal, includes coaching notes.'},

    // PROGRAMS
    {cat:'Programs', name:'Service Program',               price:8900,   priceId:'price_1SPv0yCipX1klfWPM7HLQchm', desc:'Complete order of service with biography, readings, and photo layout guidance.'},

    // THANK YOU CARDS
    {cat:'Thank You Cards', name:'Cards (10)',             price:2500,   priceId:'price_1SPv2cCipX1klfWPHnPLLMGQ', desc:'Set of 10 cards. Personalized messages for attendees, donors, pallbearers, and caregivers.'},
    {cat:'Thank You Cards', name:'Cards (25)',             price:4900,   priceId:'price_1SPv5SCipX1klfWPyjIuBASf', desc:'Set of 25 cards. Personalized messages for attendees, donors, pallbearers, and caregivers.'},
    {cat:'Thank You Cards', name:'Cards (50)',             price:8900,   priceId:'price_1SPv6YCipX1klfWPZ0CVyvMQ', desc:'Set of 50 cards. Personalized messages for attendees, donors, pallbearers, and caregivers.'},

    // LETTERS
    {cat:'Letters', name:'Legacy Letter',                  price:12900,  priceId:'price_1SQqGNCeZgmr4yWZBOtsGAaW', desc:'A keepsake. Deeply personal letter to loved ones—sharing wisdom, love, and final thoughts.'},

    // RUSH
    {cat:'Rush', name:'24-Hour Rush Service',              price:14900,  priceId:'price_1SPvHICipX1klfWP2mwzYcFj', desc:'Delivery in 24 hours.'},
    {cat:'Rush', name:'Same-Day Rush Service',             price:24900,  priceId:'price_1SPvIdCipX1klfWPDQuRJENw', desc:'Delivery same day (8 hours).'},
  ];

  const params = new URLSearchParams(location.search);
  const prePid = params.get('product');
  const preQty = parseInt(params.get('qty') || '1', 10);

  const productList = document.getElementById('product-list');
  const cartEl = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('subtotal');
  const checkoutBtn = document.getElementById('checkout');
  const cartToggle = document.getElementById('cart-toggle');
  const cartPanel  = document.getElementById('cart-panel');
  const fmt = new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD' });

  const cart = [];

  function renderProducts(){
    productList.innerHTML = '';
    let lastCat = '';
    PRODUCTS.forEach(p => {
      if (p.cat !== lastCat){
        const cat = document.createElement('div');
        cat.className = 'category';
        cat.textContent = p.cat;
        productList.appendChild(cat);
        lastCat = p.cat;
      }
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `
        <div>
          <h3 class="title">${p.name}</h3>
          <p class="desc">${p.desc || ''}</p>
        </div>
        <div class="price">${fmt.format(p.price/100)}</div>
        <button class="btn">Add to Cart</button>
      `;
      c.querySelector('button').onclick = () => addToCart(p);
      productList.appendChild(c);
    });
  }

  function addToCart(p, qty=1){
  const existing = cart.find(i => i.priceId === p.priceId);
  if (existing) existing.qty += qty;
  else cart.push({ name:p.name, price:p.price, priceId:p.priceId, qty });
  renderCart();
  // Auto-open the cart panel after adding an item
  document.getElementById('cart-panel')?.classList.add('open');
}

  function removeFromCart(pid){
    const idx = cart.findIndex(i => i.priceId === pid);
    if (idx >= 0) cart.splice(idx,1);
    renderCart();
  }

  function changeQty(pid, delta){
    const item = cart.find(i => i.priceId === pid);
    if (!item) return;
    item.qty = Math.max(1, item.qty + delta);
    renderCart();
  }

  function renderCart(){
    if (!cart.length){
      cartEl.className = 'empty';
      cartEl.textContent = 'Your cart is empty.';
      subtotalEl.textContent = fmt.format(0);
      checkoutBtn.disabled = true;

      // Update header pill
      document.getElementById('cart-count').textContent = 0;
      document.getElementById('cart-total').textContent = fmt.format(0);
      return;
    }

    cartEl.className = '';
    cartEl.innerHTML = cart.map(i => `
      <div class="row">
        <div>
          <div>${i.name}</div>
          <div class="small">${fmt.format(i.price/100)} ·
            <a href="#" data-rm="${i.priceId}" style="color:#9ad0b5">remove</a>
          </div>
        </div>
        <div class="qty">
          <button data-dec="${i.priceId}">-</button>
          <div>${i.qty}</div>
          <button data-inc="${i.priceId}">+</button>
        </div>
      </div>`).join('');

    cartEl.querySelectorAll('[data-rm]').forEach(a => a.onclick = (e)=>{e.preventDefault(); removeFromCart(a.dataset.rm);});
    cartEl.querySelectorAll('[data-inc]').forEach(b => b.onclick = ()=> changeQty(b.dataset.inc, +1));
    cartEl.querySelectorAll('[data-dec]').forEach(b => b.onclick = ()=> changeQty(b.dataset.dec, -1));

    const subtotal = cart.reduce((s,i)=> s + i.price*i.qty, 0);
    subtotalEl.textContent = fmt.format(subtotal/100);
    checkoutBtn.disabled = false;

    // Update header pill (count + total)
    const count = cart.reduce((n,i)=> n + i.qty, 0);
    document.getElementById('cart-count').textContent = count;
    document.getElementById('cart-total').textContent = fmt.format(subtotal/100);
  }

  // Toggle cart panel
  cartToggle.addEventListener('click', () => {
    cartPanel.classList.toggle('open');
  });

  // Checkout with Stripe
  checkoutBtn.onclick = async () => {
    checkoutBtn.disabled = true;
    try {
      const lineItems = cart.map(i => ({ price: i.priceId, quantity: i.qty }));
      const res = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lineItems })
      });
      const data = await res.json();
      if (!data.id) throw new Error(data.error || 'No session id returned');
      const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
      if (error) alert(error.message);
    } catch (e) {
      alert('Checkout error: ' + e.message);
    } finally {
      checkoutBtn.disabled = false;
    }
  };
// Handle Cancel button -> go to our cancel page
const cancelBtn = document.getElementById('cancel');
if (cancelBtn) {
  cancelBtn.addEventListener('click', () => {
    window.location.href = '/cancel.html';
  });
}

  // Boot
  document.addEventListener('DOMContentLoaded', () => {
    renderProducts();
    if (prePid){
      const found = PRODUCTS.find(p=>p.priceId===prePid);
      if (found) addToCart(found, preQty || 1);
    }
  });
  </script>
</body>
</html>
