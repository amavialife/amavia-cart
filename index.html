<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amavia · Cart</title>

  <style>
  :root{
    --bg:#0b0f0e;--panel:#111815;--line:#22332c;--text:#e7efe9;
    --muted:#a7b7af;--accent:#9ad0b5;
    --header-h:56px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}

  /* Header */
  header{
    position:sticky; top:0; z-index:50;
    height:var(--header-h);
    display:flex; align-items:center; justify-content:center;
    padding:0 20px; border-bottom:1px solid var(--line); background:var(--bg);
  }
  .brand{font-weight:700; font-size:18px; letter-spacing:.3px; color:var(--text)}

  /* Main layout */
  main{max-width:1200px; margin:0 auto; padding:20px; padding-top:calc(var(--header-h) + 12px); padding-bottom:90px;}
  .layout{display:grid; grid-template-columns:1.45fr 360px; gap:24px; align-items:start;}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }

  /* Grid of product cards */
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:18px; align-items:stretch;}
  .category{grid-column:1 / -1; margin:22px 0 8px; color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.12em;}

  .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; display:flex; flex-direction:column; justify-content:space-between; gap:8px; min-height:180px; transition:transform .25s ease, box-shadow .25s ease;}
  .card:hover{transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,.25); border-color:var(--accent);}
  .title{font-size:15px; font-weight:600; margin:0 0 4px}
  .desc{font-size:13px; color:var(--muted); margin:0; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:34px;}
  .price{font-size:14px; font-weight:600; margin-top:6px}
  .btn{background:var(--accent); color:#06281b; border:0; border-radius:12px; padding:10px 12px; font-weight:600; cursor:pointer; width:100%; transition:background .2s ease, transform .1s ease;}
  .btn:hover{background:#b8e4cb; transform:translateY(-1px)}
  .btn:disabled{opacity:.6; cursor:not-allowed}

  /* Cart sidebar */
  .side{position:sticky; top:calc(var(--header-h) + 16px); background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; height:max-content}
  .row{display:flex; justify-content:space-between; align-items:center; margin:8px 0}
  .small{font-size:13px; color:var(--muted)}
  .empty{color:var(--muted); text-align:center; padding:20px; border:1px dashed var(--line); border-radius:12px}
  .qty{display:flex; align-items:center; gap:8px}
  .qty button{width:28px; height:28px; border-radius:8px; border:1px solid var(--line); background:#0e1613; color:var(--text); cursor:pointer}

  /* Bottom brand bar (no button) */
  .bottom-bar{
    position:fixed; left:0; bottom:0; width:100%;
    background:var(--panel); border-top:1px solid var(--line);
    text-align:center; padding:10px 0 18px; z-index:100; box-shadow:0 -4px 12px rgba(0,0,0,.25);
  }
  .amavia-footer{color:var(--muted); font-size:13px; line-height:1.3; margin-bottom:6px;}
  .amavia-brand{font-weight:600; font-size:14px; color:var(--text); letter-spacing:.05em;}
  .tm{font-size:10px; vertical-align:super; margin-left:2px;}
  .amavia-tagline{font-style:italic; color:var(--accent); font-size:12px; letter-spacing:.04em;}

  /* Mobile sticky cart to bottom if needed */
  @media (max-width:900px){
    .side{position:static}
    main{padding-bottom:110px}
  }
  </style>
</head>

<body>
  <header>
    <div class="brand">amavia<span class="tm">™</span></div>
  </header>

  <main>
    <div class="layout">
      <section>
        <h2 style="margin:4px 0 12px 0">Templates & Services</h2>
        <div id="product-list" class="grid"></div>
      </section>

      <aside class="side">
        <h3 style="margin:0 0 8px 0">Your Cart</h3>
        <div id="cart-items" class="empty">Your cart is empty.</div>
        <div class="row"><span class="small">Subtotal</span><strong id="subtotal">$0.00</strong></div>
        <p class="notice" style="font-size:12px; color:var(--muted)">Taxes are calculated at checkout. All prices in CAD.</p>
        <button id="checkout" class="btn" disabled>Proceed to Checkout</button>
      </aside>
    </div>
  </main>

  <footer class="bottom-bar">
    <div class="amavia-footer">
      <div class="amavia-brand">amavia<span class="tm">™</span></div>
      <div class="amavia-tagline">guided by love</div>
    </div>
  </footer>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
  // 1) Your publishable test key
  const stripe = Stripe('pk_test_51SJEXtCeZgmr4yWZU6yP7VQ9bmKnZitQxo42by2n0kx428MTLxi3KjJighpbKnl7G3zUnMOwUJS7JGz0aQ2tfegs00x04Cx129');

  // 2) All 16 products
  const PRODUCTS = [
    // PACKAGES
    {cat:'Packages', name:'Essential Package',            price:19900,  priceId:'price_1SQqGsCeZgmr4yWZTYdTWkyH', desc:'Core set of memorial assets.'},
    {cat:'Packages', name:'Complete Memorial Package',     price:49900,  priceId:'price_1SPvAeCipX1klfWPE2yO6sy5', desc:'Obituary, eulogy, program & cards.'},
    {cat:'Packages', name:'Legacy Package',                price:129900, priceId:'price_1SPvD1CipX1klfWPgsL6wunX', desc:'Premium everything, white-glove.'},

    // OBITUARIES
    {cat:'Obituaries', name:'Basic Obituary',              price:14900,  priceId:'price_1SPupSCipX1klfWPOuzr6NOg', desc:'Thoughtful, polished obituary.'},
    {cat:'Obituaries', name:'Premium Obituary',            price:29900,  priceId:'price_1SPuqTCipX1klfWPCK0R9qXL', desc:'Long-form tribute with edits.'},
    {cat:'Obituaries', name:'Legacy Obituary',             price:49900,  priceId:'price_1SPuvCCipX1klfWPddKUIzrl', desc:'Executive-level storytelling.'},

    // ANNOUNCEMENTS
    {cat:'Announcements', name:'Death Announcement',       price:6900,   priceId:'price_1SPuxHCipX1klfWPgAPF5OCO', desc:'Share essential details with care.'},

    // EULOGIES
    {cat:'Eulogies', name:'Basic Eulogy',                  price:14900,  priceId:'price_1SPuzJCipX1klfWPNp6aBnyp', desc:'Sincere words for the service.'},
    {cat:'Eulogies', name:'Premium Eulogy',                price:29900,  priceId:'price_1SPv06CipX1klfWPzziESfSy', desc:'Deeper narrative & revisions.'},

    // PROGRAMS
    {cat:'Programs', name:'Service Program',               price:8900,   priceId:'price_1SPv0yCipX1klfWPM7HLQchm', desc:'Designed program for the service.'},

    // THANK YOU CARDS
    {cat:'Thank You Cards', name:'Cards (10)',             price:2500,   priceId:'price_1SPv2cCipX1klfWPHnPLLMGQ', desc:'Set of 10 notes.'},
    {cat:'Thank You Cards', name:'Cards (25)',             price:4900,   priceId:'price_1SPv5SCipX1klfWPyjIuBASf', desc:'Set of 25 notes.'},
    {cat:'Thank You Cards', name:'Cards (50)',             price:8900,   priceId:'price_1SPv6YCipX1klfWPZ0CVyvMQ', desc:'Set of 50 notes.'},

    // LETTERS
    {cat:'Letters', name:'Legacy Letter',                  price:12900,  priceId:'price_1SQqGNCeZgmr4yWZBOtsGAaW', desc:'A keepsake legacy letter.'},

    // RUSH
    {cat:'Rush', name:'24-Hour Rush Service',              price:14900,  priceId:'price_1SPvHICipX1klfWP2mwzYcFj', desc:'Delivery in 24 hours.'},
    {cat:'Rush', name:'Same-Day Rush Service',             price:24900,  priceId:'price_1SPvIdCipX1klfWPDQuRJENw', desc:'Delivery same day.'},
  ];

  const params = new URLSearchParams(location.search);
  const prePid = params.get('product');
  const preQty = parseInt(params.get('qty') || '1', 10);

  const productList = document.getElementById('product-list');
  const cartEl = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('subtotal');
  const checkoutBtn = document.getElementById('checkout');
  const fmt = new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD' });

  const cart = [];

  function renderProducts(){
    productList.innerHTML = '';
    let lastCat = '';
    PRODUCTS.forEach(p => {
      if (p.cat !== lastCat){
        const cat = document.createElement('div');
        cat.className = 'category';
        cat.textContent = p.cat;
        productList.appendChild(cat);
        lastCat = p.cat;
      }
      const c = document.createElement('div');
      c.className = 'card';
      c.innerHTML = `
        <h3 class="title">${p.name}</h3>
        <p class="desc">${p.desc || ''}</p>
        <div class="price">${fmt.format(p.price/100)}</div>
        <button class="btn">Add to Cart</button>
      `;
      c.querySelector('button').onclick = () => addToCart(p);
      productList.appendChild(c);
    });
  }

  function addToCart(p, qty=1){
    const existing = cart.find(i => i.priceId === p.priceId);
    if (existing) existing.qty += qty;
    else cart.push({ name:p.name, price:p.price, priceId:p.priceId, qty });
    renderCart();
  }

  function removeFromCart(pid){
    const idx = cart.findIndex(i => i.priceId === pid);
    if (idx >= 0) cart.splice(idx,1);
    renderCart();
  }

  function changeQty(pid, delta){
    const item = cart.find(i => i.priceId === pid);
    if (!item) return;
    item.qty = Math.max(1, item.qty + delta);
    renderCart();
  }

  function renderCart(){
    if (!cart.length){
      cartEl.className = 'empty';
      cartEl.textContent = 'Your cart is empty.';
      subtotalEl.textContent = fmt.format(0);
      checkoutBtn.disabled = true;
      return;
    }
    cartEl.className = '';
    cartEl.innerHTML = cart.map(i => `
      <div class="row">
        <div>
          <div>${i.name}</div>
          <div class="small">${fmt.format(i.price/100)} · <a href="#" data-rm="${i.priceId}" style="color:#9ad0b5">remove</a></div>
        </div>
        <div class="qty">
          <button data-dec="${i.priceId}">-</button>
          <div>${i.qty}</div>
          <button data-inc="${i.priceId}">+</button>
        </div>
      </div>`).join('');

    cartEl.querySelectorAll('[data-rm]').forEach(a => a.onclick = (e)=>{e.preventDefault(); removeFromCart(a.dataset.rm);});
    cartEl.querySelectorAll('[data-inc]').forEach(b => b.onclick = ()=> changeQty(b.dataset.inc, +1));
    cartEl.querySelectorAll('[data-dec]').forEach(b => b.onclick = ()=> changeQty(b.dataset.dec, -1));

    const subtotal = cart.reduce((s,i)=> s + i.price*i.qty, 0);
    subtotalEl.textContent = fmt.format(subtotal/100);
    checkoutBtn.disabled = false;
  }

  checkoutBtn.onclick = async () => {
    checkoutBtn.disabled = true;
    try {
      const lineItems = cart.map(i => ({ price: i.priceId, quantity: i.qty }));
      const res = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lineItems })
      });
      const data = await res.json();
      if (!data.id) throw new Error(data.error || 'No session id returned');
      const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
      if (error) alert(error.message);
    } catch (e) {
      alert('Checkout error: ' + e.message);
    } finally {
      checkoutBtn.disabled = false;
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    renderProducts();
    if (prePid){
      const found = PRODUCTS.find(p=>p.priceId===prePid);
      if (found) addToCart(found, preQty || 1);
    }
  });
  </script>
</body>
</html>
